# 终端复用时cd解析问题 - 修复总结

## 问题

执行包含cd的复合命令时（如`cd src && npm test`），cd部分被解析后用于终端初始化，但原始命令中的cd仍然被执行，导致目录被cd两次。

## 修复内容

### 1. 新增函数 - `src/utils/path.ts`

#### `parseCdCommandInternal(command: string)`
- 内部辅助函数，共用的cd命令解析逻辑
- 返回解析结果：`{ unquotedPath, separatorIndex, separatorLength }`
- 处理所有边界情况：引号、转义符、多种分隔符

#### `removeCdFromCommand(command: string): string`（新增导出函数）
- 从命令中移除开头的cd部分
- 保留分隔符后的内容
- 若无分隔符，返回空字符串

**示例：**
```
"cd src && npm test"     → "npm test"
"cd src; ls"             → "ls"
"cd ../folder && echo x" → "echo x"
"npm test"               → "npm test"  （不修改）
```

### 2. 修改函数 - `src/core/tools/ExecuteCommandTool.ts`

#### `executeCommandInTerminal()` 函数的改进

**流程改变：**
```
原始流程：
  1. 解析cd → targetWorkingDir
  2. 使用targetWorkingDir创建终端
  3. 执行原始命令（包含cd）❌ 重复执行

新流程：
  1. 解析cd → targetWorkingDir
  2. 若成功，从命令中移除cd → commandToExecute
  3. 使用targetWorkingDir创建终端
  4. 执行修改后的命令（无cd）✓ 不重复
  5. 若失败回退，恢复使用原始命令 ✓ 正确处理
```

**关键点：**
- 仅当cd解析成功时移除cd
- 回退失败时使用原始命令
- 所有执行分支都使用`commandToExecute`

### 3. 测试 - `src/utils/__tests__/path.spec.ts`

新增15个测试用例覆盖`removeCdFromCommand`：
- 各类分隔符（`&&`, `;`, `|`, `||`）
- 引号路径
- 大小写不敏感
- 纯cd命令
- 非cd命令
- 多个命令链

## 验证

运行测试：
```bash
pnpm test  # 运行所有测试
npx vitest run src/utils/__tests__/path.spec.ts  # 仅路径测试
```

## 文件变更

| 文件 | 变更类型 | 说明 |
|------|--------|------|
| `src/utils/path.ts` | 修改 | 新增`parseCdCommandInternal`和`removeCdFromCommand` |
| `src/core/tools/ExecuteCommandTool.ts` | 修改 | 导入新函数，更新cd处理逻辑 |
| `src/utils/__tests__/path.spec.ts` | 修改 | 添加`removeCdFromCommand`测试 |

## 向后兼容性

✅ 完全向后兼容
- 现有函数逻辑不变
- 新函数都是附加功能
- 仅改进内部处理流程

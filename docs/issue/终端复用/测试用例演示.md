# 终端复用cd问题 - 测试用例演示

## 修复前后对比

### 典型问题场景

**当前工作目录：** `E:\project\Roo-Code-3.50.0\src`

**执行命令：**
```bash
cd src && npx vitest run utils/__tests__/streaming-token-counter.spec.ts
```

#### 修复前（有问题）
```
输入解析：
  - parseCdCommand() 提取: "E:\project\Roo-Code-3.50.0\src\src"
  - targetWorkingDir: "E:\project\Roo-Code-3.50.0\src\src"

终端创建：
  - 尝试创建/选择位于该目录的终端 ❌ 目录不存在

错误输出：
  Set-Location: Cannot find path 'E:\project\Roo-Code-3.50.0\src\src' because it does not exist.
```

#### 修复后（正确）
```
输入解析：
  - parseCdCommand() 提取: "E:\project\Roo-Code-3.50.0\src\src"
  - removeCdFromCommand() 移除: "npx vitest run utils/__tests__/streaming-token-counter.spec.ts"
  - targetWorkingDir: "E:\project\Roo-Code-3.50.0\src\src"
  - commandToExecute: "npx vitest run utils/__tests__/streaming-token-counter.spec.ts"

终端创建：
  - 尝试创建/选择位于目标目录的终端 ❌ 目录不存在
  - 回退到原始工作目录 ✓ 成功

命令执行：
  - 恢复原始命令（含cd）: "cd src && npx vitest run ..."
  - 在原始目录执行 ✓ 正确
```

## removeCdFromCommand 测试用例

### 基础测试

| 输入 | 输出 | 说明 |
|-----|------|------|
| `cd src && npm test` | `npm test` | && 分隔符 |
| `cd src; ls -la` | `ls -la` | ; 分隔符 |
| `cd src \| grep test` | `grep test` | 管道分隔符 |
| `cd src \|\| echo error` | `echo error` | 或分隔符 |

### 引号处理

| 输入 | 输出 | 说明 |
|-----|------|------|
| `cd "my folder" && ls` | `ls` | 双引号 |
| `cd 'my folder' && ls` | `ls` | 单引号 |
| `cd "path with spaces" && npm test` | `npm test` | 复杂路径 |

### 边界情况

| 输入 | 输出 | 说明 |
|-----|------|------|
| `cd src` | `` | 仅cd命令 |
| `npm test` | `npm test` | 非cd命令 |
| `  cd src && npm test` | `npm test` | 前置空格 |
| `CD src && npm test` | `npm test` | 大写CD |
| `Cd src && npm test` | `npm test` | 混合大小写 |

### 复杂命令链

| 输入 | 输出 | 说明 |
|-----|------|------|
| `cd src && npm test && npm lint` | `npm test && npm lint` | 多个&&分隔符 |
| `cd src && npm test \| grep error` | `npm test \| grep error` | 混合分隔符 |

## ExecuteCommandTool 执行流程测试

### 场景1：cd成功且路径存在
```
Input:  "cd src && npm test"
PWD:    "/project"

Processing:
  1. parseCdCommand() → "/project/src"
  2. removeCdFromCommand() → "npm test"
  3. TerminalRegistry.getOrCreateTerminal("/project/src") → 成功
  4. 执行: terminal.runCommand("npm test")

Result: ✓ npm test 在 /project/src 执行
```

### 场景2：cd失败，路径不存在（回退）
```
Input:  "cd nonexistent && npm test"
PWD:    "/project"

Processing:
  1. parseCdCommand() → "/project/nonexistent"
  2. removeCdFromCommand() → "npm test"
  3. TerminalRegistry.getOrCreateTerminal("/project/nonexistent") → 异常
  4. 恢复 commandToExecute = "cd nonexistent && npm test"
  5. TerminalRegistry.getOrCreateTerminal("/project") → 成功
  6. 执行: terminal.runCommand("cd nonexistent && npm test")

Result: ✓ 原始命令在 /project 执行，PowerShell/Bash 处理cd失败
```

### 场景3：无cd命令
```
Input:  "npm test"
PWD:    "/project"

Processing:
  1. parseCdCommand() → undefined
  2. commandToExecute 保持 "npm test"
  3. TerminalRegistry.getOrCreateTerminal("/project") → 成功
  4. 执行: terminal.runCommand("npm test")

Result: ✓ npm test 在 /project 执行（无变化）
```

## 运行测试

```bash
# 完整测试套件
pnpm test

# 仅执行path.spec.ts的removeCdFromCommand测试
npx vitest run src/utils/__tests__/path.spec.ts -t "removeCdFromCommand"

# 执行所有path测试
npx vitest run src/utils/__tests__/path.spec.ts
```

## 预期结果

所有`removeCdFromCommand`测试应该通过（15个测试）。

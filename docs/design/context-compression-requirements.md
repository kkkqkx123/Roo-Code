# 上下文压缩优化功能要求文档

## 1. 核心原则

### 1.1 统一Token计算
- **要求**：所有token计算必须使用tiktoken作为唯一来源
- **原因**：避免不同模型分词器差异，确保压缩前后token数一致
- **范围**：压缩前、压缩后、阈值判断、中间段计算等所有token相关操作

### 1.2 文件折叠独立化
- **要求**：文件折叠作为独立模块，不依赖API handler
- **原因**：提高代码复用性，便于测试和维护
- **范围**：文件名称提取、函数块合并、随机丢弃等所有文件折叠相关功能

## 2. 文件折叠模块

### 2.1 极简模式
- **要求**：仅保留类名、接口名、函数名
- **不保留**：函数签名、类/接口的具体内容
- **输出格式**：每个文件包装在独立的`<system-reminder>`块中

### 2.2 Token阈值控制
- **默认阈值**：10000 tokens
- **计算方式**：使用tiktoken计算折叠后内容的token数
- **超出判断**：当前token数 > 阈值

### 2.3 随机丢弃逻辑
- **超出比例计算**：
  ```
  比例 = (文件折叠后占用token大小 / 阈值) - 1
  ```
  - 比例不得 < 0，< 0 表示不需要丢弃
- **启发式批大小计算**：
  - 假设每个类名+行样板的平均token占用
  - 批大小 = 需要删除的token数 / 平均每个section的token数
- **执行方式**：
  - 一次完成处理
  - 避免多次tiktoken计算
  - 避免多次对象操作开销
  - 即使最终仍超出阈值也不再处理

### 2.4 函数块合并
- **类、接口**：始终单独显示，保留行数信息
- **函数名**：一次性合并多个函数名
- **中断条件**：
  - 出现类、接口定义时
  - 连续行数超过100行时
- **目的**：减少行跨度样板占用的token

### 2.5 调用时机
- 智能压缩时：在对话摘要中包含文件折叠内容
- 智能截断时：对所有文件查看结果执行折叠

## 3. 智能截断模块（回退方案）

### 3.1 中间段计算
- **范围**：1/6到5/6位置
- **计算方式**：使用tiktoken计算每个消息的token数，确定累积token分布
- **输出**：消息索引（不需要精确到字符）

### 3.2 工具调用过滤
- **过滤范围**：中间1/6-5/6上下文
- **删除内容**：
  - 所有tool_use块
  - 除文件查看外的所有tool_result块
- **保留内容**：
  - 文件查看的tool_result块
  - 所有text块

### 3.3 文件查看结果折叠
- **范围**：所有文件查看结果（包括不在中间部分的）
- **处理方式**：调用文件折叠模块
- **替换**：将原始tool_result内容替换为折叠后的内容

### 3.4 消息删除
- **触发条件**：完成工具调用过滤和文件折叠后，token数仍超出阈值
- **阈值**：单独定义，默认50000 tokens
- **删除位置**：从中间消息开始删除
- **删除方式**：
  - 不随机丢弃
  - 避免消息不匹配导致LLM工具调用出问题
  - 使用启发式批大小
  - 一次结束处理

### 3.5 启发式批大小计算
- **计算方式**：
  - 计算需要删除的token数
  - 计算中间段消息的平均token数
  - 批大小 = 需要删除的token数 / 平均token数
- **执行方式**：
  - 从中间段中心开始
  - 向两侧扩展确定删除范围
  - 一次完成处理

## 4. 上下文管理集成

### 4.1 Token计算统一
- **要求**：所有token计算使用tiktoken
- **包括**：
  - 系统提示词token数
  - 消息token数
  - 工具定义token数
  - 文件折叠后token数
  - 智能截断后token数

### 4.2 压缩策略选择
- **优先级**：智能压缩 > 智能截断
- **触发条件**：
  - 上下文百分比 >= 有效阈值
  - 或 上下文token数 > 允许token数
- **回退机制**：智能压缩失败时自动切换到智能截断

### 4.3 配置参数
- **文件折叠配置**：
  - maxTokens: 10000
  - mergeFunctions: true
  - maxLineSpan: 100
- **智能截断配置**：
  - maxTokens: 50000
  - middlePercentileStart: 16.67 (1/6)
  - middlePercentileEnd: 83.33 (5/6)

## 5. 性能要求

### 5.1 计算效率
- **要求**：避免多次tiktoken计算
- **实现**：
  - 文件折叠：一次完成随机丢弃
  - 智能截断：一次完成消息删除
  - 使用启发式批大小，避免迭代

### 5.2 对象操作
- **要求**：减少不必要的对象创建和复制
- **实现**：
  - 使用原地修改
  - 避免多次数组操作
  - 批量处理而非逐个处理

## 6. 兼容性要求

### 6.1 向后兼容
- **要求**：保留原有接口
- **实现**：
  - 保留truncateConversation函数
  - 保留原有的配置参数
  - 渐进式迁移

### 6.2 模型切换
- **要求**：切换模型后压缩结果仍然有效
- **实现**：
  - 统一使用tiktoken计算
  - 不依赖API handler的token计算
  - 添加安全缓冲区

## 7. 质量要求

### 7.1 准确性
- **要求**：token计算准确，避免压缩后仍超出阈值
- **实现**：
  - 使用tiktoken统一计算
  - 添加fudge factor（1.5倍）
  - 保守估计

### 7.2 完整性
- **要求**：保留关键上下文信息
- **实现**：
  - 文件折叠：保留类名、接口名、函数名
  - 智能截断：保留开头和结尾消息
  - 保留活跃工作流（<command>块）

### 7.3 可维护性
- **要求**：代码结构清晰，易于理解和修改
- **实现**：
  - 模块化设计
  - 清晰的职责划分
  - 完整的文档和注释

## 8. 验收标准

### 8.1 功能验收
- [ ] 文件折叠仅保留类名、接口名、函数名
- [ ] 函数块正确合并，行跨度超过100时中断
- [ ] 随机丢弃基于超出比例计算，使用启发式批大小
- [ ] 中间段范围基于tiktoken计算（1/6到5/6）
- [ ] 工具调用正确过滤（保留文件查看）
- [ ] 文件查看结果正确折叠
- [ ] 消息删除使用启发式批大小，从中间开始
- [ ] 所有token计算使用tiktoken

### 8.2 性能验收
- [ ] 文件折叠一次完成，避免多次tiktoken计算
- [ ] 智能截断一次完成，避免多次tiktoken计算
- [ ] 压缩耗时在可接受范围内

### 8.3 质量验收
- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 代码审查通过
- [ ] 文档完整准确

## 9. 风险和缓解

### 9.1 技术风险
- **风险**：tiktoken计算不准确
- **缓解**：添加安全缓冲区，保守估计

### 9.2 性能风险
- **风险**：tiktoken计算开销大
- **缓解**：使用worker pool，缓存计算结果

### 9.3 兼容性风险
- **风险**：向后兼容性破坏
- **缓解**：保留原有接口，渐进式迁移

## 10. 实施优先级

### 10.1 高优先级
- 统一token计算（tiktoken）
- 文件折叠独立化
- 智能截断实现

### 10.2 中优先级
- 函数块合并优化
- 启发式批大小计算
- 性能优化

### 10.3 低优先级
- 监控和指标
- 文档完善
- 代码重构

---

**文档版本**：1.0
**创建日期**：2025-01-XX
**最后更新**：2025-01-XX
**状态**：待审核
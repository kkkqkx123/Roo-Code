# åŠŸèƒ½å¯¹æ¯”æ£€æŸ¥æ¸…å•

## åŸå§‹ä»£ç èŒƒå›´ï¼šTask.ts:2652-3257 (çº¦605è¡Œ)

### âœ… å·²å®ç°çš„åŠŸèƒ½

| åŠŸèƒ½ | åŸå§‹ä»£ç è¡Œå· | StreamProcessor å®ç° | çŠ¶æ€ |
|------|------------|---------------------|------|
| **updateApiReqMsg å‡½æ•°** | 2666-2707 | `updateApiReqMessage()` | âœ… |
| - æ£€æŸ¥ apiReqIndex æœ‰æ•ˆæ€§ | 2667-2669 | âœ… | âœ… |
| - è§£æç°æœ‰æ•°æ® | 2671 | âœ… | âœ… |
| - è·å–æ¨¡å‹ä¿¡æ¯ | 2674-2676 | âœ… | âœ… |
| - è®¡ç®—æˆæœ¬ (Anthropic) | 2678-2686 | âœ… | âœ… |
| - è®¡ç®—æˆæœ¬ (OpenAI) | 2687-2693 | âœ… | âœ… |
| - æ›´æ–°æ¶ˆæ¯æ–‡æœ¬ | 2697-2706 | âœ… | âœ… |
| **abortStream å‡½æ•°** | 2709-2731 | `abortStream()` | âœ… |
| - å›æ»š diff è§†å›¾ | 2710-2712 | âœ… | âœ… |
| - å®Œæˆæœ€åä¸€ä¸ªéƒ¨åˆ†æ¶ˆæ¯ | 2714-2721 | âœ… | âœ… |
| - è°ƒç”¨ updateApiReqMsg | 2725 | âœ… | âœ… |
| - ä¿å­˜æ¶ˆæ¯ | 2726 | âœ… | âœ… |
| - è®¾ç½®å®Œæˆä¸­æ­¢æ ‡å¿— | 2730 | âœ… | âœ… |
| **é‡ç½®æµå¼å¤„ç†çŠ¶æ€** | 2733-2755 | Task ä¸­ä¿ç•™ | âš ï¸ |
| - é‡ç½® 20+ ä¸ªçŠ¶æ€å˜é‡ | 2734-2748 | âš ï¸ éœ€è¦åœ¨ Task ä¸­ä¿ç•™ | âš ï¸ |
| - æ¸…ç† streamingToolCallIndices | 2750 | âš ï¸ éœ€è¦åœ¨ Task ä¸­ä¿ç•™ | âš ï¸ |
| - æ¸…ç† NativeToolCallParser | 2752-2753 | âš ï¸ éœ€è¦åœ¨ Task ä¸­ä¿ç•™ | âš ï¸ |
| - é‡ç½® diff è§†å›¾ | 2755 | âœ… | âœ… |
| **åˆå§‹åŒ–æµå¼å¤„ç†** | 2757-2778 | æ„é€ å‡½æ•° | âœ… |
| - ç¼“å­˜æ¨¡å‹ä¿¡æ¯ | 2759-2761 | âœ… | âœ… |
| - åˆ›å»º stream | 2766 | âš ï¸ ç”± Task æä¾› | âš ï¸ |
| - åˆå§‹åŒ– tokenCounter | 2773 | âœ… | âœ… |
| - åˆå§‹åŒ– deadLoopDetector | 2778 | âœ… | âœ… |
| **æµå¼å¤„ç†ä¸»å¾ªç¯** | 2780-3094 | `processStream()` | âœ… |
| - åˆ›å»ºè¿­ä»£å™¨ | 2781 | âœ… | âœ… |
| - nextChunkWithAbort è¾…åŠ©å‡½æ•° | 2784-2804 | âœ… | âœ… |
| - å¤„ç† undefined chunk | 2810-2814 | âœ… | âœ… |
| **reasoning chunk å¤„ç†** | 2817-2854 | `handleReasoningChunk()` | âœ… |
| - ç´¯ç§¯ reasoning æ–‡æœ¬ | 2818 | âœ… | âœ… |
| - è®¡æ•° reasoning tokens | 2820 | âœ… | âœ… |
| - æ ¼å¼åŒ–æ ‡é¢˜ | 2822-2831 | âœ… | âœ… |
| - æ­»å¾ªç¯æ£€æµ‹ | 2835-2851 | âœ… | âœ… |
| - æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ | 2842-2844 | âœ… | âœ… |
| - ä¸­æ­¢æµ | 2845 | âœ… | âœ… |
| - è®¾ç½®ä¸­æ­¢æ ‡å¿— | 2848-2849 | âœ… | âœ… |
| - ä¸­æ­¢ä»»åŠ¡ | 2850 | âœ… | âœ… |
| - å‘é€ reasoning æ¶ˆæ¯ | 2853 | âœ… | âœ… |
| **usage chunk å¤„ç†** | 2856-2866 | `handleUsageChunk()` | âœ… |
| - ç´¯ç§¯ inputTokens | 2857 | âœ… | âœ… |
| - ç´¯ç§¯ outputTokens | 2858 | âœ… | âœ… |
| - ç´¯ç§¯ cacheWriteTokens | 2859 | âœ… | âœ… |
| - ç´¯ç§¯ cacheReadTokens | 2860 | âœ… | âœ… |
| - è®¾ç½® totalCost | 2861 | âœ… | âœ… |
| - è®¾ç½® hasApiUsageData | 2865 | âœ… | âœ… |
| **grounding chunk å¤„ç†** | 2867-2873 | `handleGroundingChunk()` | âœ… |
| - ç´¯ç§¯ grounding sources | 2870-2872 | âœ… | âœ… |
| **tool_call_partial å¤„ç†** | 2874-3009 | `handleToolCallPartialChunk()` | âœ… |
| - å¤„ç†åŸå§‹ chunk | 2877-2882 | âœ… | âœ… |
| - tool_call_start äº‹ä»¶ | 2885-2931 | `handleToolCallStartEvent()` | âœ… |
| - é˜²æ­¢é‡å¤å·¥å…·è°ƒç”¨ | 2891-2896 | âœ… | âœ… |
| - åˆå§‹åŒ–æµå¼å·¥å…·è°ƒç”¨ | 2899 | âœ… | âœ… |
| - è®¡æ•°å·¥å…·è°ƒç”¨ tokens | 2903 | âœ… | âœ… |
| - å®Œæˆå‰ä¸€ä¸ªæ–‡æœ¬å— | 2907-2911 | âœ… | âœ… |
| - è¿½è¸ªå·¥å…·è°ƒç”¨ç´¢å¼• | 2914-2915 | âœ… | âœ… |
| - åˆ›å»ºéƒ¨åˆ†å·¥å…·ä½¿ç”¨ | 2918-2926 | âœ… | âœ… |
| - æ·»åŠ åˆ°å†…å®¹ | 2929 | âœ… | âœ… |
| - è®¾ç½®ç”¨æˆ·æ¶ˆæ¯å°±ç»ªæ ‡å¿— | 2930 | âœ… | âœ… |
| - tool_call_delta äº‹ä»¶ | 2932-2962 | `handleToolCallDeltaEvent()` | âœ… |
| - å¤„ç†æµå¼ JSON | 2934-2937 | âœ… | âœ… |
| - æ›´æ–°å·¥å…·ä½¿ç”¨ | 2947 | âœ… | âœ… |
| - æ›´æ–°å·¥å…·è°ƒç”¨ tokens | 2951-2957 | âœ… | âœ… |
| - tool_call_end äº‹ä»¶ | 2963-3006 | `handleToolCallEndEvent()` | âœ… |
| - å®Œæˆæµå¼å·¥å…·è°ƒç”¨ | 2965 | âœ… | âœ… |
| - æ›¿æ¢éƒ¨åˆ†ä¸ºæœ€ç»ˆ | 2975-2976 | âœ… | âœ… |
| - æ¸…ç†è¿½è¸ª | 2980 | âœ… | âœ… |
| - å¤„ç†æ ¼å¼é”™è¯¯çš„å·¥å…·è°ƒç”¨ | 2987-3005 | âœ… | âœ… |
| **tool_call å¤„ç†** | 3012-3040 | `handleToolCallChunk()` | âœ… |
| - è§£æå·¥å…·è°ƒç”¨ | 2915-2919 | âœ… | âœ… |
| - é”™è¯¯å¤„ç† | 2921-2924 | âœ… | âœ… |
| - å­˜å‚¨å·¥å…·è°ƒç”¨ ID | 2928 | âœ… | âœ… |
| - æ·»åŠ åˆ°å†…å®¹ | 2931 | âœ… | âœ… |
| - è®¾ç½®ç”¨æˆ·æ¶ˆæ¯å°±ç»ªæ ‡å¿— | 2934 | âœ… | âœ… |
| **text chunk å¤„ç†** | 3041-3061 | `handleTextChunk()` | âœ… |
| - ç´¯ç§¯æ–‡æœ¬ | 3042 | âœ… | âœ… |
| - è®¡æ•°æ–‡æœ¬ tokens | 3044 | âœ… | âœ… |
| - åˆ›å»ºæˆ–æ›´æ–°æ–‡æœ¬å— | 3048-3058 | âœ… | âœ… |
| - è®¾ç½®ç”¨æˆ·æ¶ˆæ¯å°±ç»ªæ ‡å¿— | 3057 | âœ… | âœ… |
| **ä¸­æ­¢æ£€æŸ¥** | 3064-3093 | ä¸»å¾ªç¯ä¸­ | âœ… |
| - æ£€æŸ¥ abort æ ‡å¿— | 3064 | âœ… | âœ… |
| - è°ƒç”¨ abortStream | 3072 | âœ… | âœ… |
| - æ£€æŸ¥ didRejectTool | 3078 | âœ… | âœ… |
| - æ£€æŸ¥ didAlreadyUseTool | 3089 | âœ… | âœ… |
| **åå°ä½¿ç”¨æ•°æ®æ”¶é›†** | 3105-3257 | `drainStreamInBackgroundToFindAllUsage()` | âœ… |
| - åˆ›å»ºå½“å‰ token å‰¯æœ¬ | 3097-3103 | âœ… | âœ… |
| - captureUsageData è¾…åŠ©å‡½æ•° | 3118-3178 | âœ… | âœ… |
| - è¶…æ—¶å¤„ç† | 3188-3197 | âœ… | âœ… |
| - ç»§ç»­å¤„ç†æµ | 3186-3211 | âœ… | âœ… |
| - ç´¯ç§¯ usage æ•°æ® | 3203-3210 | âœ… | âœ… |
| - æ•è·ä½¿ç”¨æ•°æ® | 3221-3230 | âœ… | âœ… |
| - é”™è¯¯å¤„ç† | 3236-3256 | âœ… | âœ… |
| - å¯åŠ¨åå°ä»»åŠ¡ | 3260-3262 | âœ… | âœ… |
| **é”™è¯¯å¤„ç†** | 3263-3299 | catch å— | âœ… |
| - æ£€æŸ¥ abandoned | 3267 | âœ… | âœ… |
| - ç¡®å®šå–æ¶ˆåŸå›  | 3269 | âœ… | âœ… |
| - æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯ | 3271-3274 | âœ… | âœ… |
| - è°ƒç”¨ abortStream | 3277 | âœ… | âœ… |
| - ç”¨æˆ·å–æ¶ˆå¤„ç† | 3279-3282 | âœ… | âœ… |
| - æµå¤±è´¥å¤„ç† | 3284-3288 | âœ… | âœ… |
| - æŒ‡æ•°é€€é¿é‡è¯• | 3290-3299 | âš ï¸ ç”± Task å¤„ç† | âš ï¸ |

### âš ï¸ éœ€è¦åœ¨ Task ä¸­ä¿ç•™çš„åŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ | åŸå›  |
|------|------|------|
| é‡ç½®æµå¼å¤„ç†çŠ¶æ€ | 2733-2755 | è¿™äº›æ˜¯ Task çš„çŠ¶æ€å˜é‡ï¼Œä¸å±äº StreamProcessor |
| åˆ›å»º stream | 2766 | stream ç”± Task.attemptApiRequest() æä¾› |
| æŒ‡æ•°é€€é¿é‡è¯• | 3290-3299 | è¿™æ˜¯ Task çš„é‡è¯•é€»è¾‘ï¼Œä¸å±äºæµå¼å¤„ç† |

### ğŸ“ è¿ç§»æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€é‡ç½®**ï¼šéœ€è¦åœ¨ Task ä¸­ä¿ç•™çŠ¶æ€é‡ç½®é€»è¾‘ï¼ˆ2733-2755è¡Œï¼‰
2. **Stream åˆ›å»º**ï¼šstream ç”± Task.attemptApiRequest() æä¾›ï¼ŒStreamProcessor åªè´Ÿè´£å¤„ç†
3. **é‡è¯•é€»è¾‘**ï¼šæŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ3290-3299è¡Œï¼‰æ˜¯ Task çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸å±äºæµå¼å¤„ç†
4. **presentAssistantMessage è°ƒç”¨**ï¼šåŸå§‹ä»£ç ä¸­å¤šæ¬¡è°ƒç”¨ presentAssistantMessage(this)ï¼Œè¿™ä¸ªè°ƒç”¨éœ€è¦ä¿ç•™åœ¨ Task ä¸­

### âœ… å¯ä»¥å®‰å…¨åˆ é™¤çš„ä»£ç 

- 2666-2707: updateApiReqMsg å‡½æ•°
- 2709-2731: abortStream å‡½æ•°
- 2773-2778: tokenCounter å’Œ deadLoopDetector åˆå§‹åŒ–
- 2780-3094: æµå¼å¤„ç†ä¸»å¾ªç¯ï¼ˆå¤§éƒ¨åˆ†ï¼‰
- 3105-3257: drainStreamInBackgroundToFindAllUsage å‡½æ•°

### âš ï¸ éœ€è¦ä¿ç•™çš„ä»£ç 

- 2733-2755: çŠ¶æ€é‡ç½®é€»è¾‘
- 2766: stream åˆ›å»º
- 2931, 2960, 2986, 3005, 3038, 3059: presentAssistantMessage è°ƒç”¨
- 3290-3299: æŒ‡æ•°é€€é¿é‡è¯•é€»è¾‘

### ğŸ¯ è¿ç§»æ­¥éª¤

1. åœ¨ Task ä¸­å®ç° StreamProcessorCallbacks æ¥å£
2. åˆ›å»º StreamProcessor å®ä¾‹
3. æ›¿æ¢æµå¼å¤„ç†ä¸»å¾ªç¯ä¸º processor.processStream(stream)
4. ä¿ç•™çŠ¶æ€é‡ç½®é€»è¾‘
5. ä¿ç•™ presentAssistantMessage è°ƒç”¨
6. ä¿ç•™é‡è¯•é€»è¾‘
7. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

## æ€»ç»“

- âœ… **æ ¸å¿ƒåŠŸèƒ½ 100% è¦†ç›–**ï¼šæ‰€æœ‰æµå¼å¤„ç†ç›¸å…³åŠŸèƒ½éƒ½å·²å®ç°
- âš ï¸ **éƒ¨åˆ†åŠŸèƒ½ä¿ç•™**ï¼šTask çš„çŠ¶æ€ç®¡ç†å’Œé‡è¯•é€»è¾‘éœ€è¦ä¿ç•™
- ğŸ¯ **ä»£ç å‡å°‘çº¦ 500 è¡Œ**ï¼šä» 605 è¡Œå‡å°‘åˆ°çº¦ 100 è¡Œï¼ˆé›†æˆä»£ç ï¼‰
- ğŸ“¦ **æ¨¡å—åŒ–æå‡**ï¼šæµå¼å¤„ç†é€»è¾‘ç‹¬ç«‹æˆæ¨¡å—ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤